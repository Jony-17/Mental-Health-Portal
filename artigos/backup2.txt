<?php
        // Define o número de itens por página
        $itens_por_pagina = 6;

        // Página atual. Se não for fornecido na URL, assume a primeira página (1)
        $pagina_atual = isset($_GET['pagina']) ? $_GET['pagina'] : 1;

        // Calcula o offset para a consulta SQL com base na página atual
        $offset = ($pagina_atual - 1) * $itens_por_pagina;

        // Consulta SQL com limitação para paginação
        $query_paginacao = "SELECT artigos.juncao_perturbacoes_id, perturbacoes.nome AS perturbacao_nome, grupos_perturbacoes.nome AS grupo_nome, artigos.titulo, artigos.descricao, artigos.data_publicacao, artigos.autor, artigos.img_artigo 
                        FROM artigos 
                        INNER JOIN juncao_perturbacoes ON artigos.juncao_perturbacoes_id = juncao_perturbacoes.juncao_perturbacoes_id
                        INNER JOIN perturbacoes ON juncao_perturbacoes.perturbacoes_id = perturbacoes.perturbacoes_id
                        INNER JOIN grupos_perturbacoes ON juncao_perturbacoes.grupos_perturbacoes_id = grupos_perturbacoes.grupos_perturbacoes_id LIMIT $itens_por_pagina OFFSET $offset";

        // Executa a consulta SQL geral
        $result_paginacao = mysqli_query($conn, $query_paginacao);

        // Verifica o número total de resultados
        $total_resultados = mysqli_num_rows(mysqli_query($conn, "SELECT * FROM artigos"));

        // Calcula o número total de páginas
        $total_paginas = ceil($total_resultados / $itens_por_pagina);

        if (isset($_GET['search_query']) && !empty($_GET['search_query'])) {
            // Se a busca estiver ativa
            $search_query = $_GET['search_query'];
            $query = "SELECT artigos.juncao_perturbacoes_id, perturbacoes.nome AS perturbacao_nome, grupos_perturbacoes.nome AS grupo_nome, artigos.titulo, artigos.descricao, artigos.data_publicacao, artigos.autor, artigos.img_artigo 
                      FROM artigos 
                      INNER JOIN juncao_perturbacoes ON artigos.juncao_perturbacoes_id = juncao_perturbacoes.juncao_perturbacoes_id
                      INNER JOIN perturbacoes ON juncao_perturbacoes.perturbacoes_id = perturbacoes.perturbacoes_id
                      INNER JOIN grupos_perturbacoes ON juncao_perturbacoes.grupos_perturbacoes_id = grupos_perturbacoes.grupos_perturbacoes_id
                      WHERE artigos.titulo LIKE '%$search_query%'";

        } else if (isset($_GET['filter']) && $_GET['filter'] !== '') {
            // Se um filtro estiver ativo
            $filtro_nome = urldecode($_GET['filter']); // Descodificar o nome do filtro, se necessário
        
            if ($filtro_nome === 'Perturbações') {
                // Se o filtro for 'Perturbações', mostrar todos os artigos
                $query = "SELECT artigos.juncao_perturbacoes_id, perturbacoes.nome AS perturbacao_nome, grupos_perturbacoes.nome AS grupo_nome, artigos.titulo, artigos.descricao, artigos.data_publicacao, artigos.autor, artigos.img_artigo 
                          FROM artigos 
                          INNER JOIN juncao_perturbacoes ON artigos.juncao_perturbacoes_id = juncao_perturbacoes.juncao_perturbacoes_id
                          INNER JOIN perturbacoes ON juncao_perturbacoes.perturbacoes_id = perturbacoes.perturbacoes_id
                          INNER JOIN grupos_perturbacoes ON juncao_perturbacoes.grupos_perturbacoes_id = grupos_perturbacoes.grupos_perturbacoes_id LIMIT $itens_por_pagina OFFSET $offset";
            } else {
                // Se um filtro específico estiver ativo, mostrar todos os artigos correspondentes a esse filtro
                $query_id = "SELECT perturbacoes_id FROM perturbacoes WHERE nome = '$filtro_nome'";
                $result_id = mysqli_query($conn, $query_id);

                if ($result_id && mysqli_num_rows($result_id) > 0) {
                    $row_id = mysqli_fetch_assoc($result_id);
                    $perturbacao_id = $row_id['perturbacoes_id'];

                    // Ajustar a consulta SQL para selecionar os artigos relacionados ao filtro
                    $query = "SELECT artigos.juncao_perturbacoes_id, perturbacoes.nome AS perturbacao_nome, grupos_perturbacoes.nome AS grupo_nome, artigos.titulo, artigos.descricao, artigos.data_publicacao, artigos.autor, artigos.img_artigo 
                              FROM artigos 
                              INNER JOIN juncao_perturbacoes ON artigos.juncao_perturbacoes_id = juncao_perturbacoes.juncao_perturbacoes_id
                              INNER JOIN perturbacoes ON juncao_perturbacoes.perturbacoes_id = perturbacoes.perturbacoes_id
                              INNER JOIN grupos_perturbacoes ON juncao_perturbacoes.grupos_perturbacoes_id = grupos_perturbacoes.grupos_perturbacoes_id
                              WHERE perturbacoes.perturbacoes_id = $perturbacao_id";
                } else {
                    // Se o filtro não for encontrado, você pode lidar com isso aqui
                    // Por exemplo, redirecionar para uma página de erro ou mostrar uma mensagem de erro
                    echo "Filtro não encontrado.";
                }
            }
        } else {
            // Exibir os resultados da consulta geral apenas se não houver busca ou filtro ativo
            if ($result_paginacao && mysqli_num_rows($result_paginacao) > 0) {
                ?>
                    <div class="card-container">
                        <?php
                        while ($row = mysqli_fetch_assoc($result_paginacao)) {
                            ?>
                            <div class="card">
                                <?php
                                $titulo_codificado = urlencode($row["titulo"]);
                                ?>
                                <a href="artigo/?titulo=<?php echo $titulo_codificado; ?>">

                                    <img src="<?php echo $row["img_artigo"] ?>" width="100%" alt="<?php echo $row["titulo"] ?>">
                                </a>
                                <div class="card4-content">
                                    <h3>
                                    <?php echo $row["perturbacao_nome"] ?>
                                    </h3>
                                    <h2>
                                    <?php echo $row["grupo_nome"] ?>
                                    </h2>
                                    <h1>
                                    <?php echo $row["titulo"] ?>
                                    </h1>
                                    <p>
                                    <?php echo $row['data_publicacao'] ?>
                                    </p>
                                    <p>
                                    <?php echo $row['autor'] ?>
                                    </p>
                                </div>
                            </div>
                        <?php
                        }
                        ?>
                    </div>
                <?php
            } else {
                echo '<div style="margin: 100px 100px 50px 100px; font-size: 20px;">Nenhum artigo encontrado.</div>';
            }
        }

        // Executar a consulta com filtro
        $result = mysqli_query($conn, $query);

        if ($result && mysqli_num_rows($result) > 0) {
            // Exibir os resultados da consulta com filtro
            ?>
            <div class="card-container">
                <?php
                while ($row = mysqli_fetch_assoc($result)) {
                    ?>
                    <div class="card">
                        <?php
                        $titulo_codificado = urlencode($row["titulo"]);
                        ?>
                        <a href="artigo/?titulo=<?php echo $titulo_codificado; ?>">

                            <img src="<?php echo $row["img_artigo"] ?>" width="100%" alt="<?php echo $row["titulo"] ?>">
                        </a>
                        <div class="card4-content">
                            <h3>
                                <?php echo $row["perturbacao_nome"] ?>
                            </h3>
                            <h2>
                                <?php echo $row["grupo_nome"] ?>
                            </h2>
                            <h1>
                                <?php echo $row["titulo"] ?>
                            </h1>
                            <p>
                                <?php echo $row['data_publicacao'] ?>
                            </p>
                            <p>
                                <?php echo $row['autor'] ?>
                            </p>
                        </div>
                    </div>
                    <?php
                }
                ?>
            </div>
            <?php
        } else {
            echo '<div style="margin: 100px 100px 50px 100px; font-size: 20px;">Nenhum artigo encontrado.</div>';
        }
        ?>

        <?php
        // Verifica se há páginas além da primeira
        if ($total_paginas > 1) {
            ?>
            <div class='paginacao'>
                <?php
                // Link para a página anterior
                if ($pagina_atual > 1) {
                    echo "<a href='?pagina=" . ($pagina_atual - 1) . "'>Anterior</a> ";
                }

                // Exibe os números das páginas
                for ($pagina = 1; $pagina <= $total_paginas; $pagina++) {
                    $classe_pagina_atual = ($pagina == $pagina_atual) ? "pagina-atual" : "";
                    echo "<a class='$classe_pagina_atual' href='?pagina=$pagina'>$pagina</a> ";
                }

                // Link para a próxima página
                if ($pagina_atual < $total_paginas) {
                    echo "<a href='?pagina=" . ($pagina_atual + 1) . "'>Seguinte</a>";
                }
                ?>
            </div>
            <?php
        }
        ?>



    </section>